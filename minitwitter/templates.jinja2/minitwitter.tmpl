{% extends 'skel.tmpl' %}

{% block content %}

<script>
var timeToCheckForNewUpdated = 5000;
var lastUpdate = "";

function allLoaded(){
    setInterval(function() {
        getLastestTweetPostTime();
    }, timeToCheckForNewUpdated);
}

function getTweetFormat(date,message,author){
   html = `<section class="post">
           <header class="post-header">
                <img alt="Some avatar" class="post-avatar" src="https://api.adorable.io/avatars/48/`+author+`.png" width="48" height="48">
                <h2 class="post-title">`+message+`</h2>
                <p class="post-meta">By `+author+` on `+date+`</p>
            </header>
            <div class="post-description"><p>&nbsp;</p></div>
        </section>`;
   return html;
}

function getDateFormat(dateString){
    var reggie = /(\d{2}).(\d{2}).(\d{4}) (\d{2}):(\d{2}):(\d{2})/;
    var dateArray = reggie.exec(dateString);
    var dateObject = new Date(
        (+dateArray[3]),
        (+dateArray[2])-1, // Careful, month starts at 0!
        (+dateArray[1]),
        (+dateArray[4]),
        (+dateArray[5]),
        (+dateArray[6])
    );
    return dateObject;
}

function addOnlyNewTweets(lastUpdate, tweets){
    var jsonTweets = JSON.parse(tweets);
    var arrayLength = jsonTweets.length;
    var newHTMLContent = "";
    for (var i = 0; i < arrayLength; i++) {
        tweet = jsonTweets[i];
        date = tweet["date"];
        message = tweet["tweet"];
        author = tweet["author"];
        if(getDateFormat(date)>getDateFormat(lastUpdate)){ //only if new tweets
           newHTMLContent = newHTMLContent+getTweetFormat(date,message,author);
        }
    }
    var htmlTweets = document.getElementById("javascriptTweets");
    htmlTweets.innerHTML = newHTMLContent+htmlTweets.innerHTML;
}

function getAllTweetsViaAJAX(lastUpdate){
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var tweets = this.responseText;
      addOnlyNewTweets(lastUpdate,tweets);
    }
    if (this.readyState == 4 && this.status == 400) {
      return;
    }
  };
  xhttp.open("GET", "getAllTweetsAJAX", true);
  xhttp.send();
}

function getNewTweetsAndShowThem(lastUpdate){
    var copyOfLastUpdate = lastUpdate; //besser eine kopie erstellen falls es ueberschrieben wird
    getAllTweetsViaAJAX(copyOfLastUpdate);
}

function checkForNewUpdated(receivedLatestTime){

   if(lastUpdate == ""){ //first time page Loaded
     lastUpdate = receivedLatestTime;
     return;
   }
   if(lastUpdate != receivedLatestTime){
     console.log("geil was neues");
     getNewTweetsAndShowThem(lastUpdate);
     lastUpdate = receivedLatestTime;
   } else {
     console.log("nix neues");
   }

}

function getLastestTweetPostTime(){
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      checkForNewUpdated(this.responseText);
    }
    if (this.readyState == 4 && this.status == 400) {
      //checkForNewUpdated(this.responseText);
      //besser einfach nix tun
    }
  };
  xhttp.open("GET", "getLastTweetTime", true);
  xhttp.send();
}

window.onload = allLoaded();
</script>

    <h1 class="content-subhead">The Tweets</h1>

    <div id="javascriptTweets"></div>

    {% for tweet in tweets: %}
        <section class="post">
           <header class="post-header">
                <img alt="Some avatar" class="post-avatar" src="https://api.adorable.io/avatars/48/{{tweet.author}}.png" width="48" height="48">
                <h2 class="post-title">{{tweet.tweet|safe}}</h2>
                <p class="post-meta">By {{tweet.author|safe}} on {{tweet.date|safe}}</p>
            </header>
            <div class="post-description"><p>&nbsp;</p></div>
        </section>
    {% endfor %}

{% endblock %}